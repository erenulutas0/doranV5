server:
  port: 8080  # Gateway'in portu

spring:
  application:
    name: api-gateway  # Servis adı
  
  # Redis yapılandırması (Rate Limiting için)
  data:
    redis:
      host: redis
      port: 6379
      password:  # Şifre yoksa boş bırakın
      timeout: 2000ms  # Connection timeout
  
  cloud:
    gateway:
      # CORS is handled by CorsConfig.java bean
      
      # Default filters (tüm route'lar için geçerli)
      default-filters:
        - name: Retry
          args:
            retries: 3  # 3 kez tekrar dene
            statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE  # Bu status kodlarında retry yap
            methods: GET,POST  # Sadece GET ve POST için retry
            backoff:
              firstBackoff: 50ms  # İlk retry 50ms sonra
              maxBackoff: 500ms  # Maksimum 500ms bekle
              factor: 2  # Her retry'de bekleme süresini 2 katına çıkar
              basedOnPreviousValue: false
        
      routes:
        # User Service route
        # /api/users/** ile başlayan istekler user-service'e gider
        - id: user-service
          uri: lb://user-service  # lb = load balancer, Eureka'dan adres alır
          predicates:
            - Path=/api/users/**  # Bu path ile başlayan istekler
          filters:
            - StripPrefix=1  # /api kısmını çıkarır, /users/** kalır
            # Rate Limiting
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 20  # User service için daha yüksek limit
                redis-rate-limiter.burstCapacity: 40
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            # CircuitBreaker
            - name: CircuitBreaker
              args:
                name: userServiceCircuitBreaker
                fallbackUri: forward:/fallback/user
        
        # Product Service route
        - id: product-service
          uri: lb://product-service
          predicates:
            - Path=/api/products/**
          filters:
            - StripPrefix=1  # /api kısmını çıkarır
            # Rate Limiting (Product Service için özel limit)
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 30  # Product service için daha yüksek limit
                redis-rate-limiter.burstCapacity: 60
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: CircuitBreaker
              args:
                name: productServiceCircuitBreaker
                fallbackUri: forward:/fallback/product
        
        # Order Service route
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - StripPrefix=1  # /api kısmını çıkarır
            # Rate Limiting (Order Service için özel limit)
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 15  # Order service için orta limit
                redis-rate-limiter.burstCapacity: 30
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: CircuitBreaker
              args:
                name: orderServiceCircuitBreaker
                fallbackUri: forward:/fallback/order
        
        # Inventory Service route
        - id: inventory-service
          uri: lb://inventory-service
          predicates:
            - Path=/api/inventory/**
          filters:
            - StripPrefix=1  # /api kısmını çıkarır
            # Rate Limiting (Inventory Service için özel limit)
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 25  # Inventory service için yüksek limit
                redis-rate-limiter.burstCapacity: 50
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: CircuitBreaker
              args:
                name: inventoryServiceCircuitBreaker
                fallbackUri: forward:/fallback/inventory
        
        # Notification Service route
        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/api/notifications/**
          filters:
            - StripPrefix=1  # /api kısmını çıkarır
            # Rate Limiting (Notification Service için özel limit)
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 20  # Notification service için orta limit
                redis-rate-limiter.burstCapacity: 40
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: CircuitBreaker
              args:
                name: notificationServiceCircuitBreaker
                fallbackUri: forward:/fallback/notification
        
        # Review Service route (v1)
        - id: review-service-v1
          uri: lb://review-service
          predicates:
            - Path=/api/v1/reviews/**
          filters:
            - StripPrefix=2  # /api/v1 kısmını çıkarır, /reviews/** kalır
            - AddRequestHeader=X-API-Version, v1
            # Rate Limiting (Review Service için özel limit)
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 30  # Review service için yüksek limit (okuma yoğun)
                redis-rate-limiter.burstCapacity: 60
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: CircuitBreaker
              args:
                name: reviewServiceCircuitBreaker
                fallbackUri: forward:/fallback/review
        
        # Media Service route (v1)
        - id: media-service-v1
          uri: lb://media-service
          predicates:
            - Path=/api/v1/media/**
          filters:
            - StripPrefix=2  # /api/v1 kısmını çıkarır, /media/** kalır
            - AddRequestHeader=X-API-Version, v1
            # Rate Limiting (Media Service için özel limit - dosya upload yoğun)
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10  # Media service için düşük limit (upload yoğun)
                redis-rate-limiter.burstCapacity: 20
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: CircuitBreaker
              args:
                name: mediaServiceCircuitBreaker
                fallbackUri: forward:/fallback/media
        
        # Own Product Service route (v1)
        - id: own-product-service-v1
          uri: lb://own-product-service
          predicates:
            - Path=/api/v1/user-products/**
          filters:
            - StripPrefix=2  # /api/v1 kısmını çıkarır, /user-products/** kalır
            - AddRequestHeader=X-API-Version, v1
            # Rate Limiting (Own Product Service için özel limit)
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 30  # Own Product service için yüksek limit (okuma yoğun)
                redis-rate-limiter.burstCapacity: 60
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: CircuitBreaker
              args:
                name: ownProductServiceCircuitBreaker
                fallbackUri: forward:/fallback/own-product
        
        # Shop Service route (v1)
        - id: shop-service-v1
          uri: lb://shop-service
          predicates:
            - Path=/api/v1/shops/**
          filters:
            - StripPrefix=2  # /api/v1 kısmını çıkarır, /shops/** kalır
            - AddRequestHeader=X-API-Version, v1
            - name: CircuitBreaker
              args:
                name: shopServiceCircuitBreaker
                fallbackUri: forward:/fallback/shop
        
        # Jobs Service route (v1)
        - id: jobs-service-v1
          uri: lb://jobs-service
          predicates:
            - Path=/api/v1/jobs/**
          filters:
            - StripPrefix=2  # /api/v1 kısmını çıkarır, /jobs/** kalır
            - AddRequestHeader=X-API-Version, v1
            - name: CircuitBreaker
              args:
                name: jobsServiceCircuitBreaker
                fallbackUri: forward:/fallback/jobs
        
        # Hobby Group Service route (v1)
        - id: hobby-group-service-v1
          uri: lb://hobby-group-service
          predicates:
            - Path=/api/v1/hobby-groups/**
          filters:
            - StripPrefix=2  # /api/v1 kısmını çıkarır, /hobby-groups/** kalır
            - AddRequestHeader=X-API-Version, v1
            - name: CircuitBreaker
              args:
                name: hobbyGroupServiceCircuitBreaker
                fallbackUri: forward:/fallback/hobby-group
        
        # Entertainment Service route (v1)
        - id: entertainment-service-v1
          uri: lb://entertainment-service
          predicates:
            - Path=/api/v1/venues/**,/api/v1/events/**
          filters:
            - StripPrefix=2  # /api/v1 kısmını çıkarır
            - AddRequestHeader=X-API-Version, v1
            - name: CircuitBreaker
              args:
                name: entertainmentServiceCircuitBreaker
                fallbackUri: forward:/fallback/entertainment

# Eureka yapılandırması
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/  # Service Registry'nin adresi

# Resilience4j Circuit Breaker Yapılandırması (Gateway seviyesinde)
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        recordExceptions:
          - org.springframework.web.client.HttpServerErrorException
          - java.net.ConnectException
          - java.net.SocketTimeoutException
          - java.util.concurrent.TimeoutException
    instances:
      userServiceCircuitBreaker:
        baseConfig: default
      productServiceCircuitBreaker:
        baseConfig: default
      orderServiceCircuitBreaker:
        baseConfig: default
      inventoryServiceCircuitBreaker:
        baseConfig: default
      notificationServiceCircuitBreaker:
        baseConfig: default
      reviewServiceCircuitBreaker:
        baseConfig: default

# Actuator endpoints (Monitoring için)
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,metrics  # Gateway routes'ları görmek için
      base-path: /actuator  # Actuator base path
  endpoint:
    gateway:
      enabled: true  # Gateway endpoint'ini aktif et
    health:
      show-details: always  # Health check detaylarını göster
  metrics:
    export:
      prometheus:
        enabled: true  # Prometheus metrics (opsiyonel)
